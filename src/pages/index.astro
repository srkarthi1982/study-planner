---
import { AvBreadcrumb, AvButton, AvCard, AvContainer } from "@ansiversa/components";
import AppShell from "../layouts/AppShell.astro";
import { buildStudyPlannerDashboardSummary } from "../dashboard/summary.schema";

const title = "Study Planner â€“ Ansiversa";
const description = "Plan study sessions, manage tasks, and stay on track.";

const userId = Astro.locals.user?.id;
const summary = userId ? await buildStudyPlannerDashboardSummary(userId) : null;
---

<AppShell title={title} description={description}>
  <section class="av-faq-public__crumb">
    <AvContainer>
      <AvBreadcrumb items={[{ label: "Home" }]} />
    </AvContainer>
  </section>

  <section class="av-section">
    <AvContainer>
      <div class="av-auth-stack-lg">
        <AvCard className="av-auth-stack-md">
          <div class="av-auth-stack-sm">
            <div>
              <p class="av-kicker">Study Planner</p>
              <h1 class="av-section-title">Your study dashboard</h1>
              <p class="av-text-soft">
                Keep plans, tasks, and logs in one focused flow.
              </p>
            </div>
            <div class="av-row-wrap">
              <AvButton href="/plans">Create plan</AvButton>
              <AvButton href="/today" variant="ghost">View today</AvButton>
            </div>
          </div>
        </AvCard>

        <div class="av-grid-cols-3">
          <AvCard variant="soft" className="av-auth-stack-sm">
            <h2 class="av-card-heading">Plans</h2>
            <p class="av-text-soft">{summary ? summary.totals.plans : 0} total</p>
            <p class="av-text-soft">{summary ? summary.totals.activePlans : 0} active</p>
          </AvCard>
          <AvCard variant="soft" className="av-auth-stack-sm">
            <h2 class="av-card-heading">Tasks</h2>
            <p class="av-text-soft">{summary ? summary.totals.tasks : 0} total</p>
            <p class="av-text-soft">{summary ? summary.totals.tasksCompleted : 0} completed</p>
          </AvCard>
          <AvCard variant="soft" className="av-auth-stack-sm">
            <h2 class="av-card-heading">Today</h2>
            <p class="av-text-soft">{summary ? summary.totals.tasksDueToday : 0} due today</p>
            <p class="av-text-soft">{summary ? summary.totals.overdueTasks : 0} overdue</p>
            <p class="av-text-soft">{summary ? summary.activity.logsThisWeek : 0} logs this week</p>
          </AvCard>
        </div>

        <AvCard variant="soft" className="av-auth-stack-md">
          <div class="av-auth-stack-xs">
            <h2 class="av-card-heading">Recent activity</h2>
            <p class="av-text-soft">
              {summary?.activity.lastCompletedTaskAt
                ? `Last completed task: ${new Date(summary.activity.lastCompletedTaskAt).toLocaleString()}`
                : "No completed tasks yet."}
            </p>
            <p class="av-text-soft">
              {summary?.activity.lastActivityAt
                ? `Last activity: ${new Date(summary.activity.lastActivityAt).toLocaleString()}`
                : "No recent activity yet."}
            </p>
          </div>
        </AvCard>
      </div>
    </AvContainer>
  </section>
</AppShell>
